<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Talkito (tipo Talkomatic)</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="card" id="join-card">
    <h1>üó®Ô∏è Talkito</h1>
    <p>Entra a una sala y chatea en tiempo real.</p>
    <form id="join">
      <label>Tu nombre
        <input id="name" required placeholder="Ej: Juli√°n">
      </label>
      <label>Sala
        <input id="room" required placeholder="Ej: amigos" value="lobby">
      </label>
      <button type="button" id="join-btn">Entrar</button>
    </form>
  </div>

  <div class="card hidden" id="chat-card">
    <header>
      <h2 id="room-title"></h2>
      <div id="status"></div>
    </header>
    <ul id="messages"></ul>
    <form id="send">
      <input id="text" autocomplete="off" placeholder="Escribe..." />
      <button>Enviar</button>
    </form>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    let socket;
    const $ = (q) => document.querySelector(q);
    const joinCard = $('#join-card');
    const chatCard = $('#chat-card');
    const roomTitle = $('#room-title');
    const status = $('#status');
    const messages = $('#messages');
    const send = $('#send');
    const text = $('#text');

    document.getElementById('join-btn').addEventListener('click', () => {
      const name = $('#name').value.trim() || 'An√≥nimo';
      const room = $('#room').value.trim() || 'lobby';

      socket = io({ query: { name, room } });

      roomTitle.textContent = 'Sala: ' + room;
      joinCard.classList.add('hidden');
      chatCard.classList.remove('hidden');
      text.focus();

      socket.on('connect', () => status.textContent = 'Conectado');
      socket.on('disconnect', () => status.textContent = 'Desconectado');
      socket.on('system', (msg) => addSystem(msg));
      socket.on('chat', (data) => addMessage(data.name, data.msg));
      socket.on('typing', ({name, isTyping}) => {
        status.textContent = isTyping ? (name + ' est√° escribiendo...') : 'Conectado';
      });

      text.addEventListener('input', () => {
        if (socket && socket.connected) socket.emit('typing', text.value.length > 0);
      });
    });

    send.addEventListener('submit', (e) => {
      e.preventDefault();
      if (!socket) return;
      const msg = text.value.trim();
      if (!msg) return;
      socket.emit('chat', msg);
      addMessage('T√∫', msg);
      text.value = '';
      socket.emit('typing', false);
      text.focus();
    });

    function addMessage(name, msg) {
      const li = document.createElement('li');
      li.innerHTML = '<strong>' + escapeHtml(name) + ':</strong> ' + linkify(escapeHtml(msg));
      messages.appendChild(li);
      messages.scrollTop = messages.scrollHeight;
    }
    function addSystem(msg) {
      const li = document.createElement('li');
      li.className = 'sys';
      li.textContent = msg;
      messages.appendChild(li);
      messages.scrollTop = messages.scrollHeight;
    }
    function escapeHtml(s) {
      return s.replace(/[&<>"']/g, (c) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',\"'\":'&#39;'}[c]));
    }
    function linkify(s) {
      return s.replace(/(https?:\/\/[^\s]+)/g, '<a href=\"$1\" target=\"_blank\" rel=\"noopener\">$1</a>');
    }
  </script>
</body>
</html>
